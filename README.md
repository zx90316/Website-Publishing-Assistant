# 網站發布助手使用說明

## 概述

網站發布助手是一個用於自動化網站部署的桌面應用程式，支援定時發布、合併式部署、多伺服器同步發布和日期時間驗證。

## 功能特色

- 🖥️ **現代化圖形介面** - 使用 tkinter 建構的直觀GUI，無需網頁瀏覽器
- 📁 **靈活的檔案選擇** - 支援選擇多個檔案或資料夾進行發布
- 🗑️ **智能檔案保護** - 可設定發布時排除特定檔案（如 web.config），保護伺服器重要配置
- 🌐 **多伺服器部署** - 同時向多個目標伺服器部署，支援專案資料夾結構
- 📅 **日期時間驗證** - 定時發布支援日期選擇，防止設定過去時間
- ⚛️ **合併式部署** - 智能合併本地檔案與伺服器既有檔案，保護重要資料
- 🔍 **檔案衝突檢測** - 部署前檢查本地檔案是否包含需要保護的檔案
- 📊 **詳細日誌記錄** - 完整記錄部署過程，支援問題診斷
- 💾 **配置持久化** - 自動儲存所有設定，重啟程式後自動恢復
- 📧 **SMTP 郵件通知** - 支援定時發布完成後自動發送郵件通知，包含發布結果和日誌內容

## 系統需求

- Windows 10/11（支援 Windows SSH 環境）
- Python 3.7+
- 必要套件：
  - tkinter（通常隨Python安裝）
  - paramiko（SSH連接）
  - tkcalendar（日期選擇器）
  - json（配置管理）
  - threading（多執行緒支援）

## 安裝說明

### 方法一：直接執行 Python 程式

1. 確保已安裝 Python 3.7 或以上版本
2. 安裝必要套件：
   ```bash
   pip install paramiko tkcalendar
   ```
3. 執行程式：
   ```bash
   python app.py
   ```

### 方法二：打包成 EXE 執行檔

使用 PyInstaller 將程式打包成獨立的執行檔：

1. 安裝 PyInstaller：
   ```bash
   pip install pyinstaller
   ```

2. 打包程式：
   ```bash
   pyinstaller --onefile --windowed --name="網站發布助手" app.py
   ```

3. 打包完成後，在 `dist` 資料夾中會生成 `網站發布助手.exe` 檔案

## 使用方法

### 1. 基本設定

#### 1.1 設定發行檔案
1. 開啟程式，切換到「設定」頁面
2. 在「目標發行檔案」區域：
   - 點擊「新增檔案」選擇單個檔案
   - 點擊「新增資料夾」選擇整個資料夾
   - 選中項目後點擊「移除」可刪除不需要的項目

#### 1.2 設定需保護的檔案
1. 在「發布前需刪除的檔案」區域
2. 在文字欄位中輸入檔案名稱（如：`web.config`、`appsettings.json`）
3. 點擊「新增」按鈕
4. 可新增多個檔案，選中後點擊「移除」可刪除
5. 點擊「測試刪除檔案」可檢查本地檔案衝突

#### 1.3 設定目標伺服器
1. 在「目標伺服器」區域點擊「新增伺服器」
2. 在對話框中填入：
   - **IP地址**：伺服器的IP位址
   - **使用者名稱**：SSH登入使用者名稱
   - **密碼**：SSH登入密碼
   - **目標路徑**：部署到伺服器的父目錄路徑（如：`D:\websites`）
   - **SSH埠號**：SSH連接埠（預設22）
3. 點擊「確定」儲存
4. 可新增多個伺服器，選中後點擊「移除」可刪除或「編輯」修改
5. 點擊「測試連接」驗證伺服器連接

#### 1.4 設定 SMTP 郵件通知
1. 切換到「SMTP 設定」頁面
2. 設定 SMTP 伺服器資訊：
   - **SMTP 伺服器**：郵件伺服器地址（如：smtp.gmail.com）
   - **SMTP 埠號**：伺服器埠號（預設587）
   - **使用者名稱**：郵件帳號
   - **密碼**：郵件密碼或應用程式密碼
   - **使用 TLS**：是否啟用 TLS 加密（建議開啟）
3. 點擊「儲存 SMTP 設定」保存配置
4. 點擊「測試 SMTP 連接」驗證郵件伺服器連接

**Google Gmail 設定說明**：
如果使用 Gmail，需要進行以下設定：
1. 開啟 Google 帳戶的「兩步驟驗證」
2. 前往 Google 帳戶設定 → 安全性 → 應用程式密碼
3. 生成一個新的應用程式密碼（16位英數字組合）
4. 在程式的「密碼」欄位中輸入應用程式密碼，而非 Google 帳號密碼
5. SMTP 設定：
   - SMTP 伺服器：`smtp.gmail.com`
   - SMTP 埠號：`587`
   - 使用 TLS：`啟用`

**常見錯誤排解**：
- 確認 Gmail 地址格式正確（如：user@gmail.com）
- 應用程式密碼輸入時不需要空格（16位連續字符）
- 如出現 "Username and Password not accepted" 錯誤：
  1. 檢查兩步驟驗證是否已啟用
  2. 重新生成新的應用程式密碼
  3. 確認使用的是應用程式密碼而非普通密碼

#### 1.5 設定通知收件人
1. 在「通知收件人管理」區域
2. 在文字欄位中輸入收件人郵件地址
3. 點擊「新增收件人」按鈕
4. 可新增多個收件人，選中後點擊「移除收件人」可刪除
5. 選擇特定收件人後點擊「發送測試郵件」可測試郵件發送功能

### 2. 發布操作

#### 2.1 立即發布
1. 切換到「發布」頁面
2. 確認所有設定正確
3. 點擊「立即發布」按鈕
4. 程式會顯示發布進度和狀態

#### 2.2 定時發布
1. 在「發布」頁面的「定時發布設定」區域
2. 選擇發布日期（點擊日期欄位開啟日曆）
3. 設定發布時間（24小時制）
4. 點擊「設定定時發布」
5. 程式會顯示：
   - 下次發布時間
   - 倒數計時
   - 目標伺服器列表
6. 如需取消，點擊「取消定時」

**重要提醒**：
- 只有定時發布會自動發送郵件通知，立即發布不會發送通知
- 郵件主旨格式：發布日期 + 發布成功/失敗狀態
- 郵件內容包含完整的發布過程日誌
- 程式異常終止時也會自動發送錯誤通知郵件

### 3. 合併式部署流程

程式使用以下步驟確保部署的安全性和完整性：

1. **驗證設定**：檢查源檔案、目標伺服器和網路連接
2. **檔案衝突檢測**：檢查本地檔案是否包含需要保護的檔案
3. **建立專案結構**：在伺服器父目錄下為每個源目錄建立專案資料夾
4. **檔案過濾上傳**：跳過需要保護的檔案，只上傳必要的更新檔案
5. **合併部署**：使用 xcopy (Windows) 或 rsync (Linux) 進行智能合併
6. **保護重要檔案**：伺服器上的 web.config、資料庫檔案等重要檔案得到保留
7. **功能更新**：新的功能檔案覆蓋舊版本，實現版本升級
8. **清理臨時檔案**：清除部署過程中的臨時檔案

### 4. 專案資料夾結構

假設伺服器路徑設定為 `D:\websites`，源檔案為：
- `C:\projects\website1`
- `C:\projects\website2`

部署後的伺服器結構：
```
D:\websites\
├── website1\
│   ├── index.html (更新的檔案)
│   ├── style.css (更新的檔案)
│   ├── web.config (保護的伺服器檔案)
│   └── data.db (保護的伺服器檔案)
└── website2\
    ├── app.js (更新的檔案)
    ├── config.json (保護的伺服器檔案)
    └── logs\ (保護的伺服器目錄)
```

這個流程確保：
- 部署過程中服務不會中斷
- 功能檔案得到正確更新
- 伺服器重要配置檔案被保護
- 資料庫和日誌檔案不會遺失

## 設定檔說明

程式會自動在執行目錄下建立 `config.json` 檔案，包含所有設定資訊：

```json
{
  "source_files": ["檔案或資料夾路徑列表"],
  "delete_files": ["需要保護的檔案名稱列表"],
  "servers": [
    {
      "ip": "伺服器IP",
      "username": "使用者名稱",
      "password": "密碼",
      "path": "目標父目錄路徑",
      "port": 22
    }
  ],
  "schedule_time": "定時發布時間（ISO格式）",
  "smtp_config": {
    "smtp_server": "SMTP伺服器地址",
    "smtp_port": 587,
    "username": "郵件帳號",
    "password": "郵件密碼",
    "use_tls": true
  },
  "notification_emails": ["收件人郵件地址列表"]
}
```

## 日誌系統

程式會在 `logs` 目錄下建立日誌檔案：
- 檔案名稱格式：`publish_YYYYMMDD.log`
- 記錄內容：連接測試、檔案上傳、部署過程、錯誤訊息
- 日誌等級：INFO（一般資訊）、WARNING（警告）、ERROR（錯誤）

## 注意事項

### 安全性
- 密碼以明文形式儲存在設定檔中，請確保檔案安全性
- 建議使用專用的部署帳號，限制其權限範圍
- 定期更改SSH密碼
- 避免在不安全的網路環境下使用

### 網路需求
- 確保能夠透過SSH連接到目標伺服器
- 防火牆需要開放SSH端口（通常是22）
- 建議在內網環境下使用
- 支援Windows SSH環境的中文字符處理

### 檔案權限
- 確保SSH使用者對目標路徑有寫入權限
- 如果目標路徑不存在，程式會嘗試建立
- Windows環境下需要適當的檔案系統權限

### 測試建議
- 首次使用前，建議在測試環境中驗證功能
- 使用「測試連接」和「測試刪除檔案」功能驗證設定
- 重要的生產環境部署前，建議先進行完整備份
- 可以使用本地SSH測試功能正確性

## 疑難排解

### 常見問題

1. **SSH連接失敗**
   - 檢查IP地址、使用者名稱和密碼
   - 確認SSH服務已啟動
   - 檢查防火牆設定
   - 確認網路連通性

2. **UTF-8編碼錯誤**
   - 程式已支援多種編碼格式
   - 自動處理繁體中文（CP950）和簡體中文（GBK）
   - 如仍有問題，檢查系統區域設定

3. **檔案上傳失敗**
   - 檢查目標路徑權限
   - 確認磁碟空間充足
   - 檢查檔案是否被其他程序佔用
   - 確認SFTP目錄建立成功

4. **定時發布不執行**
   - 確認電腦在設定時間仍在運行
   - 檢查系統時間是否正確
   - 查看程式是否意外關閉
   - 檢查日期設定是否為未來時間

5. **檔案衝突檢測問題**
   - 使用「測試刪除檔案」功能診斷
   - 檢查檔案路徑和名稱是否正確
   - 確認本地檔案存在性

6. **SMTP 郵件發送失敗**
   - 檢查 SMTP 伺服器設定是否正確
   - 確認使用者名稱和密碼正確（Gmail 需使用應用程式密碼）
   - 檢查網路連接和防火牆設定
   - 確認 TLS 設定與伺服器要求一致
   - 使用「測試 SMTP 連接」功能診斷問題

### 錯誤日誌

程式運行時的詳細錯誤會記錄在日誌檔案中，包含：
- 連接錯誤的詳細訊息
- 檔案操作失敗的原因
- 部署過程的完整記錄
- 時間戳記和錯誤等級

## 版本資訊

- **版本**：2.0.0
- **最後更新**：2025年7月
- **支援平台**：Windows 10/11
- **開發語言**：Python 3.7+
- **主要改進**：
  - 合併式部署機制
  - 專案資料夾結構支援
  - 日期時間驗證
  - 檔案衝突檢測
  - Windows SSH 環境相容性
  - UTF-8編碼問題修復

## 技術支援

如遇到問題或需要功能改進，請：
1. 查看 `logs` 目錄下的日誌檔案
2. 使用測試功能診斷問題
3. 參考原始碼進行自訂修改
4. 聯絡開發團隊獲得技術支援

---

**警告**：本程式涉及伺服器檔案操作，使用前請務必在測試環境中驗證功能，並確保有適當的備份措施。部署前請充分了解合併式部署的工作原理。